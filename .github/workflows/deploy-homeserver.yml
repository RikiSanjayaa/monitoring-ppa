name: Deploy Homeserver

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: Force Docker app image rebuild
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-homeserver
  cancel-in-progress: true

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          extensions: mbstring, intl, pdo_sqlite, dom, fileinfo
          coverage: none

      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Prepare test environment
        run: |
          cp .env.example .env
          php artisan key:generate

      - name: Run formatter check
        run: ./vendor/bin/pint --test

      - name: Run tests
        run: php artisan test

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Connect to Tailscale
        uses: tailscale/github-action@v3
        with:
          authkey: ${{ secrets.TS_AUTHKEY }}

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.HOMESERVER_SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_deploy
          chmod 600 ~/.ssh/id_deploy

      - name: Add homeserver host key
        run: |
          mkdir -p ~/.ssh
          touch ~/.ssh/known_hosts
          ssh-keyscan -H "${{ secrets.HOMESERVER_HOST }}" >> ~/.ssh/known_hosts || true

      - name: Deploy via SSH
        env:
          HOMESERVER_HOST: ${{ secrets.HOMESERVER_HOST }}
          HOMESERVER_USER: ${{ secrets.HOMESERVER_USER }}
          APP_DIR: ${{ secrets.HOMESERVER_APP_DIR }}
          FORCE_REBUILD: ${{ inputs.force_rebuild }}
          COMPOSE_FILE_PATH: compose.prod.yaml
        run: |
          ssh -i ~/.ssh/id_deploy \
            -o StrictHostKeyChecking=accept-new \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            "${HOMESERVER_USER}@${HOMESERVER_HOST}" \
            "APP_DIR='${APP_DIR}' BRANCH='${GITHUB_REF_NAME}' FORCE_REBUILD='${FORCE_REBUILD}' COMPOSE_FILE_PATH='${COMPOSE_FILE_PATH}' bash -s" \
            < scripts/deploy-homeserver.sh
